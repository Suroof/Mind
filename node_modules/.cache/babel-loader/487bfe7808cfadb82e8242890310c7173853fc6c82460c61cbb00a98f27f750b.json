{"ast":null,"code":"import { createSlice } from '@reduxjs/toolkit';\nimport { findTopicById, isDescendant, updateTopicTreeStatus, updateParentStatus } from '../utils/topicUtils';\nconst initialState = {\n  currentMap: null,\n  selectedTopic: null\n};\nconst mindMapSlice = createSlice({\n  name: 'mindMap',\n  initialState,\n  reducers: {\n    toggleTopicComplete(state, action) {\n      if (!state.currentMap) return;\n      const topic = findTopicById(state.currentMap.rootTopic, action.payload);\n      if (topic) {\n        topic.isCompleted = !topic.isCompleted;\n\n        // 1. 先更新当前节点及其子树\n        updateTopicTreeStatus(topic);\n\n        // 2. 从根节点开始，检查并更新所有节点的状态\n        updateParentStatus(state.currentMap.rootTopic);\n      }\n    },\n    updateTopicColor(state, action) {\n      var _state$currentMap;\n      const topic = findTopicById((_state$currentMap = state.currentMap) === null || _state$currentMap === void 0 ? void 0 : _state$currentMap.rootTopic, action.payload.id);\n      if (topic) {\n        topic.color = action.payload.color;\n      }\n    },\n    addTopic(state, action) {\n      const newTopic = {\n        id: Date.now().toString(),\n        // 简单的ID生成\n        title: action.payload.title,\n        isCompleted: false,\n        children: []\n      };\n      if (action.payload.parentId) {\n        var _state$currentMap2;\n        const parentTopic = findTopicById((_state$currentMap2 = state.currentMap) === null || _state$currentMap2 === void 0 ? void 0 : _state$currentMap2.rootTopic, action.payload.parentId);\n        if (parentTopic) {\n          parentTopic.children.push(newTopic);\n          newTopic.parent = parentTopic;\n        }\n      } else if (state.currentMap) {\n        state.currentMap.rootTopic.children.push(newTopic);\n        newTopic.parent = state.currentMap.rootTopic;\n      }\n    },\n    connectTopics(state, action) {\n      if (!state.currentMap) return;\n      const sourceTopic = findTopicById(state.currentMap.rootTopic, action.payload.sourceId);\n      const targetTopic = findTopicById(state.currentMap.rootTopic, action.payload.targetId);\n      if (sourceTopic && targetTopic) {\n        // 防止循环引用\n        if (isDescendant(targetTopic, sourceTopic)) return;\n\n        // 从原父节点中移除\n        if (sourceTopic.parent) {\n          sourceTopic.parent.children = sourceTopic.parent.children.filter(child => child.id !== sourceTopic.id);\n        }\n\n        // 添加到新父节点\n        targetTopic.children.push(sourceTopic);\n        sourceTopic.parent = targetTopic;\n      }\n    }\n  }\n});\nexport const {\n  toggleTopicComplete,\n  updateTopicColor,\n  addTopic,\n  connectTopics\n} = mindMapSlice.actions;\nexport default mindMapSlice;","map":{"version":3,"names":["createSlice","findTopicById","isDescendant","updateTopicTreeStatus","updateParentStatus","initialState","currentMap","selectedTopic","mindMapSlice","name","reducers","toggleTopicComplete","state","action","topic","rootTopic","payload","isCompleted","updateTopicColor","_state$currentMap","id","color","addTopic","newTopic","Date","now","toString","title","children","parentId","_state$currentMap2","parentTopic","push","parent","connectTopics","sourceTopic","sourceId","targetTopic","targetId","filter","child","actions"],"sources":["D:/Work/SIWEI/src/store/mindMapSlice.ts"],"sourcesContent":["import { createSlice, PayloadAction } from '@reduxjs/toolkit';\r\nimport { MindMap, Topic } from '../types/MindMap';\r\nimport { findTopicById, updateParentProgress, isDescendant, updateTopicTreeStatus, updateParentStatus } from '../utils/topicUtils';\r\n\r\ninterface MindMapState {\r\n  currentMap: MindMap | null;\r\n  selectedTopic: string | null;\r\n}\r\n\r\nconst initialState: MindMapState = {\r\n  currentMap: null,\r\n  selectedTopic: null,\r\n};\r\n\r\nconst mindMapSlice = createSlice({\r\n  name: 'mindMap',\r\n  initialState,\r\n  reducers: {\r\n    toggleTopicComplete(state, action: PayloadAction<string>) {\r\n      if (!state.currentMap) return;\r\n      const topic = findTopicById(state.currentMap.rootTopic, action.payload);\r\n      if (topic) {\r\n        topic.isCompleted = !topic.isCompleted;\r\n\r\n        // 1. 先更新当前节点及其子树\r\n        updateTopicTreeStatus(topic);\r\n\r\n        // 2. 从根节点开始，检查并更新所有节点的状态\r\n        updateParentStatus(state.currentMap.rootTopic);\r\n      }\r\n    },\r\n\r\n    updateTopicColor(state, action: PayloadAction<{id: string; color: string}>) {\r\n      const topic = findTopicById(state.currentMap?.rootTopic, action.payload.id);\r\n      if (topic) {\r\n        topic.color = action.payload.color;\r\n      }\r\n    },\r\n\r\n    addTopic(state, action: PayloadAction<{title: string; parentId: string | null}>) {\r\n      const newTopic: Topic = {\r\n        id: Date.now().toString(), // 简单的ID生成\r\n        title: action.payload.title,\r\n        isCompleted: false,\r\n        children: []\r\n      };\r\n\r\n      if (action.payload.parentId) {\r\n        const parentTopic = findTopicById(state.currentMap?.rootTopic, action.payload.parentId);\r\n        if (parentTopic) {\r\n          parentTopic.children.push(newTopic);\r\n          newTopic.parent = parentTopic;\r\n        }\r\n      } else if (state.currentMap) {\r\n        state.currentMap.rootTopic.children.push(newTopic);\r\n        newTopic.parent = state.currentMap.rootTopic;\r\n      }\r\n    },\r\n\r\n    connectTopics(state, action: PayloadAction<{sourceId: string; targetId: string}>) {\r\n      if (!state.currentMap) return;\r\n\r\n      const sourceTopic = findTopicById(state.currentMap.rootTopic, action.payload.sourceId);\r\n      const targetTopic = findTopicById(state.currentMap.rootTopic, action.payload.targetId);\r\n\r\n      if (sourceTopic && targetTopic) {\r\n        // 防止循环引用\r\n        if (isDescendant(targetTopic, sourceTopic)) return;\r\n\r\n        // 从原父节点中移除\r\n        if (sourceTopic.parent) {\r\n          sourceTopic.parent.children = sourceTopic.parent.children.filter(\r\n            child => child.id !== sourceTopic.id\r\n          );\r\n        }\r\n\r\n        // 添加到新父节点\r\n        targetTopic.children.push(sourceTopic);\r\n        sourceTopic.parent = targetTopic;\r\n      }\r\n    }\r\n  }\r\n});\r\n\r\nexport const {\r\n  toggleTopicComplete,\r\n  updateTopicColor,\r\n  addTopic,\r\n  connectTopics\r\n} = mindMapSlice.actions;\r\nexport default mindMapSlice;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}